### 콜백 함수 내부에서 외부 데이터를 사용하고자 할 때

```javascript
// (1) 콜백 함수를 내부함수로 선언해서 외부변수를 직접 참조하는 방법 - 클로저 발생 O
var fruits = ['apple', 'banana', 'peach']
var $ul = document.createElement('ul')        // (공통 코드)

fruits.forEach(function (fruit) {             // (A)
  var $li = document.createElement('li')
  $li.innerText = fruit
  $li.addEventListener('click', function () { // (B)
    alert('your choice is ' + fruit)
  })
  $ul.appendChild($li)
})
document.body.appendChild($ul)
```

- addEventListener에 넘겨준 콜백 함수(B)에는 fruit이라는 외부 변수를 참조하고 있으므로 클로저가 있다.
- 클릭 이벤트에 의해 각 컨텍스트의 (B)가 실행될 때는 (B)의 outerEnvironmentReference가 (A)의 LexicalEnvironment를 참조하게 된다.
- 따라서 최소한 (B) 함수가 참조할 예정인 변수 fruit에 대해서는 (A)가 종료된 후에도 GC 대상에서 제외되어 계속 참조 가능할 것이다.

### 공통 함수로 쓰고자 콜백 함수를 외부로 꺼내어, fruit를 인자로 받아 출력하는 형태로 바꾸어 보자.

```javascript
// (2) bind 메서드로 값을 직접 넘겨주는 방법 - 클로저 발생 X. but 제약사항 발생
var alertFruit = function (fruit) {
  alert('your choice is ' + fruit)
}
fruits.forEach(function (fruit) {
  var $li = document.createElement('li')
  $li.innerText = fruit
  $li.addEventListener('click', alertFruit.bind(null, fruit))
  $ul.appendChild($li)
})
document.body.appendChild($ul)
alertFruit(fruits[1])
```

- 공통 함수로 쓰고자 콜백 함수를 외부로 꺼내어 alerFruit라는 변수에 담았다.
  - 근데 각 li를 클릭하면 클릭한 대상의 과일명이 아닌 \[object MouseEvent]라는 값이 출력된다.
  - 콜백 함수의 인자에 대한 제어권을 addEventListener가 가진 상태이며, addEventListener는 콜백 함수를 호출할 때 첫 번째 인자에 '이벤트 객체'를 주입하기 때문이다.
  - 이 문제는 bind 메서드를 활용하면 손쉽게 해결 가능하다.
- 다만 이렇게 하면 이벤트 객체가 인자로 넘어오는 순서가 바뀌는 점 및 함수 내부에서의 this가 원래의 그것과 달라지는 점은 감안해야 한다.
- bind 메서드로 값을 직접 넘겨준 덕분에 클로저는 발생하지 않게 된 반면 여러 가지 제약사항이 따르게 됐다.

### 이런 변경사항이 발생하지 않게끔 하면서 이슈를 해결하기 위해서 고차함수를 활용할 수 있다.

```javascript
// (3) 콜백 함수를 고차함수로 바꾸는 방법 - 클로저 발생 O
var alertFruitBuilder = function (fruit) {
  return function () {
    alert('your choice is ' + fruit)
  }
}
fruits.forEach(function (fruit) {
  var $li = document.createElement('li')
  $li.innerText = fruit
  $li.addEventListener('click', alertFruitBuilder(fruit))
  $ul.appendChild($li)
})
```

- alertFruitBuilder의 실행 결과로 반환된 함수에는 클로저가 존재한다.
- (궁금증) 근데 그냥 `$li.addEventListener('click', () => alertFruit(fruit))` 이렇게 하면 안 되나? 이거랑 뭔 차이지?
  - 아, 이게 어차피 (1)번 방법이랑 똑같은 거구나. 공통 함수로 쓰려고 콜백 함수를 외부로 꺼내고 싶은 상황에서 고차함수 방법이 나오게 됨.
