## 1. 흔히 잘못 이해하는 Connection 헤더

HTTP는 클라이언트와 서버 사이에 프락시 서버, 캐시 서버 등과 같은 중개 서버가 놓이는 것을 허락한다.

**HTTP 메시지는 클라이언트에서 서버(혹은 리버스 서버)까지 중개 서버들을 하나하나 거치면서 전달된다.**

어떤 경우에는, 두 개의 인접한 HTTP 애플리케이션이 현재 맺고 있는 커넥션에만 적용될 옵션을 지정해야 할 때가 있다.

HTTP Connection 헤더 필드는 커넥션 토큰을 쉼표로 구분하여 가지고 있으며, 그 값들은 다른 커넥션에 전달되지 않는다.

예를 들어, 다음 메시지를 보낸 다음 끊어져야 할 커넥션은 Connection: close라고 명시할 수 있다.

<img width="500" alt="" src="https://github.com/user-attachments/assets/b281d96c-8f8d-4d53-8b5d-d0396d02f537" />

Connection 헤더에는 다음 세 가지 종류의 토큰이 전달될 수 있기 때문에 다소 혼란스러울 수 있다.

- HTTP 헤더 필드 명은, 이 커넥션에만 해당되는 헤더들을 나열한다.
- 임시적인 토큰 값은, 커넥션에 대한 비표준 옵션을 의미한다.
- close 값은, 커넥션이 작업이 완료되면 종료되어야 함을 의미한다.

**커넥션 토큰이 HTTP 헤더 필드 명을 가지고 있으면, 해당 필드들은 현재 커넥션만을 위한 정보이므로 다음 커넥션에 전달하면 안 된다.**

**Connection 헤더에 있는 모든 헤더 필드는 메시지를 다른 곳으로 전달하는 시점에 삭제되어야 한다.**

Connection 헤더에는 홉별(hop-by-hop) 헤더 명을 기술하는데, 이것을 '헤더 보호하기'라 한다.

Connection 헤더에 명시된 헤더들이 전달되는 것을 방지하기 때문이다.

**HTTP 애플리케이션이 Connection 헤더와 함께 메시지를 전달받으면, 수신자는 송신자에게서 온 요청에 기술되어 있는 모든 옵션을 적용한다.**

**그리고 다음 홉(hop)에 메시지를 전달하기 전에 Connection 헤더와 Connection 헤더에 기술되어 있던 모든 헤더를 삭제한다.**

또한, Connection 헤더에 기술되어 있지는 않더라도, 홉별 헤더인 것들도 있다.

예를 들면 Proxy-Authenticate, Proxy-Connection, Transfer-Encoding, Upgrade 같은 것이다.

## 2. 순차적인 트랜잭션 처리에 의한 지연

커넥션 관리가 제대로 이루어지지 않으면 TCP 성능이 매우 안 좋아질 수 있다.

예를 들어 3개의 이미지가 있는 웹페이지가 있다고 해보자.

브라우저가 이 페이지를 보여주려면 네 개의 HTTP 트랜잭션을 만들어야 한다.

하나는 해당 HTMP을 받기 위해, 나머지 세 개는 첨부된 이미지를 받기 위한 것이다.

**각 트랜잭션이 새로운 커넥션을 필요로 한다면, 커넥션을 맺는데 발생하는 지연과 함께 느린 시작 지연이 발생할 것이다.**

순차적인 처리로 인한 지연에는 물리적인 지연뿐 아니라, 하나의 이미지를 내려받고 있는 중에는 웹페이지의 나머지 공간에 아무런 변화가 없어서 느껴지는 심리적인 지연도 있다.

사용자는 여러 개의 이미지가 동시에 로드되는 것을 더 좋아한다.

순차적으로 로드하는 방식의 또 하나의 단점은, 특정 브라우저의 경우 객체를 화면에 배치하려면 객체의 크기를 알아야 하기 때문에, 모든 객체를 내려받기 전까지는 텅 빈 화면을 보여준다는 것이다.

이 경우 브라우저는 객체들을 연속해서 하나씩 내려받는 것이 효율적이겠으나, 사용자는 어떻게 진행되고 있는지 모르는 상태로 흰색의 텅 빈 화면만 보게 된다.

HTTP 커넥션의 성능을 향상시킬 수 있는 여러 최신 기술이 있다.

이제 그런 기술 네 가지에 대해서 알아보자.

### 병렬(parallel) 커넥션

여러 개의 TCP 커넥션을 통한 동시 HTTP 요청

### 지속(persistent) 커넥션

커넥션을 맺고 끊는 데서 발생하는 지연을 제거하기 위한 TCP 커넥션의 재활용

### 파이프라인(pipelined) 커넥션

공유 TCP 커넥션을 통한 병렬 HTTP 요청

### 다중(multiplexed) 커넥션

요청과 응답들에 대한 중재(실험적인 기술이다)
